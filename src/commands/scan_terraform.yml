description: Scan a Terraform plan using Cloudrail, looking for security vulnerabilities.

parameters:
  cloudrail_api_key:
    description: |
      The Cloudrail API key to use.
    type: string
  plan_output_file:
    description: |
      The plan file that was created with "terraform plan -out=filename".
    type: string
  tf_directory:
    description: |
      The directory where the Terraform code is located, must have a ".terraform" directory directly inside it (that is - a "terraform init" was run there).
    type: string

steps:
  - run:
      name: Analyze Terraform plan with Cloudrail
      environment:
        CLOUDRAIL_API_KEY: "<<parameters.cloudrail_api_key>>"
        PLAN_FILE: "<<parameters.plan_output_file>>"
        TF_DIRECTORY: "<<parameters.tf_directory>>"
      command: |
        run --directory $TF_DIRECTORY --tf-plan $PLAH_FILE --api-key $CLOUDRAIL_API_KEY